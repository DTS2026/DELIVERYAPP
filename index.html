<script>
let pedidos = [];
let pedidosFiltrados = [];
let timer = null;

const buscador = document.getElementById("buscador");
const resultados = document.getElementById("resultados");
const filtroVendedor = document.getElementById("filtroVendedor");

fetch("pedidos.json")
  .then(res => res.json())
  .then(data => {
    pedidos = data;
    cargarVendedores();
  });

function cargarVendedores() {
  const vendedores = [...new Set(pedidos.map(p => p["VENDEDOR"]).filter(v => v))];
  vendedores.sort();

  vendedores.forEach(v => {
    const option = document.createElement("option");
    option.value = v;
    option.textContent = v;
    filtroVendedor.appendChild(option);
  });
}

filtroVendedor.addEventListener("change", () => {
  buscador.value = "";
  filtrarPorVendedor();
});

buscador.addEventListener("input", () => {
  clearTimeout(timer);
  timer = setTimeout(filtrarPorVendedor, 300);
});

function filtrarPorVendedor() {
  const vendedor = filtroVendedor.value;
  const texto = buscador.value.toLowerCase().trim();

  resultados.innerHTML = "";

  if (!vendedor) return;

  pedidosFiltrados = pedidos.filter(p => p["VENDEDOR"] === vendedor);

  if (texto.length >= 2) {
    pedidosFiltrados = pedidosFiltrados.filter(p =>
      String(p["CODIGO.CLIENTE"]).includes(texto) ||
      p["NOMBRE.CLIENTE"].toLowerCase().includes(texto)
    );
  }

  agruparYPintar(pedidosFiltrados);
}

function agruparYPintar(lista) {
  const clientes = {};

  lista.forEach(p => {
    const key = p["CODIGO.CLIENTE"];
    if (!clientes[key]) {
      clientes[key] = {
        codigo: key,
        nombre: p["NOMBRE.CLIENTE"],
        distrito: p["distrito"],
        conductor: p["CONDUCTOR"],
        placa: p["VEHICULO"],
        liquidador: p["LIQUIDADOR"],
        contacto: p["NROS DE CONTACTO"],
        total: 0,
        productos: []
      };
    }

    clientes[key].productos.push(p);
    clientes[key].total += Number(p["Monto"] || 0);
  });

  Object.values(clientes).forEach(c => pintarCliente(c));
}

function pintarCliente(c) {
  const div = document.createElement("div");
  div.className = "cliente";

  const productosHTML = c.productos.map(p =>
    `<div>â€¢ ${p["Descripcion"]} â€” ${p["Unidades Programadas"]} ${p["unidad"]}</div>`
  ).join("");

  div.innerHTML = `
    <h3>${c.nombre}</h3>
    <div class="info">CÃ³digo: ${c.codigo}</div>
    <div class="info">Distrito: ${c.distrito}</div>
    <div class="info">ðŸšš ${c.conductor} | ðŸš› ${c.placa}</div>
    <div class="info">ðŸ‘· ${c.liquidador} | ðŸ“ž ${c.contacto}</div>

    <div class="total">TOTAL: S/ ${c.total.toFixed(2)}</div>

    <button class="btn-toggle" onclick="toggleProductos(this)">Ver productos</button>
    <div class="productos">${productosHTML}</div>

    <button class="btn-wsp" onclick='compartir(${JSON.stringify(c)})'>
      ðŸ“² Compartir por WhatsApp
    </button>
  `;

  resultados.appendChild(div);
}

function toggleProductos(btn) {
  const prod = btn.nextElementSibling;
  prod.style.display = prod.style.display === "none" ? "block" : "none";
  btn.textContent = prod.style.display === "none" ? "Ver productos" : "Ocultar productos";
}

function compartir(c) {
  const productos = c.productos
    .map(p => `â€¢ ${p["Descripcion"]} (${p["Unidades Programadas"]})`)
    .join("\n");

  const mensaje =
`HOJA DE RUTA â€“ GRUPODN
Cliente: ${c.nombre}

${productos}

TOTAL: S/ ${c.total.toFixed(2)}

Conductor: ${c.conductor}
Placa: ${c.placa}
Liquidador: ${c.liquidador}
Contacto: ${c.contacto}`;

  window.open("https://wa.me/?text=" + encodeURIComponent(mensaje));
}
</script>
