<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pedidos ‚Äì Grupo DN</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f4f6f8;
}

header {
  background: #1f3a5f;
  color: white;
  padding: 12px;
  text-align: center;
}

.container {
  padding: 15px;
}

input {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  margin-bottom: 10px;
}

.card {
  background: white;
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 6px;
  box-shadow: 0 2px 5px rgba(0,0,0,.1);
}

.products {
  margin-top: 8px;
  padding-left: 15px;
}

.products li {
  margin-bottom: 4px;
}

.total {
  font-weight: bold;
  margin-top: 8px;
}

.whatsapp {
  background: #25D366;
  color: white;
  border: none;
  padding: 10px;
  width: 100%;
  margin-top: 10px;
  font-weight: bold;
  border-radius: 4px;
}
</style>
</head>

<body>

<header>
  <h2>üì¶ Consulta de Pedidos</h2>
</header>

<div class="container">
  <input
    type="text"
    id="buscar"
    placeholder="Buscar por c√≥digo o nombre del cliente"
  >
  <div id="resultados"></div>
</div>

<script>
let pedidos = [];
let timer = null;

fetch('pedidos.json')
  .then(r => r.json())
  .then(data => pedidos = data);

document.getElementById('buscar').addEventListener('keyup', e => {
  clearTimeout(timer);
  timer = setTimeout(() => buscar(e.target.value), 300);
});

function buscar(texto) {
  const txt = texto.trim().toLowerCase();
  resultados.innerHTML = '';
  if (txt.length < 2) return;

  const filtrados = pedidos.filter(p =>
    String(p["CODIGO.CLIENTE"]).includes(txt) ||
    p["NOMBRE.CLIENTE"]?.toLowerCase().includes(txt)
  );

  const agrupados = agruparPedidos(filtrados);
  renderizar(agrupados);
}

function agruparPedidos(data) {
  const map = {};

  data.forEach(p => {
    const key = p["CODIGO.CLIENTE"] + '-' + p["COM.IDHR_FK"];

    if (!map[key]) {
      map[key] = {
        cliente: p["NOMBRE.CLIENTE"],
        codigo: p["CODIGO.CLIENTE"],
        pedido: p["COM.IDHR_FK"],
        vehiculo: p["VEHICULO"],
        conductor: p["CONDUCTOR"],
        liquidador: p["LIQUIDADOR"],
        contacto: p["NROS DE CONTACTO"],
        productos: [],
        total: 0
      };
    }

    map[key].productos.push(
      `${p["Descripcion"]} ‚Äì ${p["Unidades Programadas"] || 0} ${p["unidad"]}`
    );

    map[key].total += Number(p["Monto"] || 0);
  });

  return Object.values(map);
}

function renderizar(lista) {
  if (!lista.length) {
    resultados.innerHTML = '<p>No hay resultados</p>';
    return;
  }

  lista.forEach(p => {
    const textoWhatsApp = `
üì¶ Pedido: ${p.pedido}
üë§ Cliente: ${p.cliente}

üöö Placa: ${p.vehiculo}
üë®‚Äç‚úàÔ∏è Conductor: ${p.conductor}
üßæ Liquidador: ${p.liquidador}
üìû Contacto: ${p.contacto}

üì¶ Productos:
${p.productos.map(x => '‚Ä¢ ' + x).join('\n')}

üí∞ Total: S/ ${p.total.toFixed(2)}
`.trim();

    resultados.innerHTML += `
      <div class="card">
        <b>${p.cliente}</b><br>
        C√≥digo: ${p.codigo}<br>
        Pedido: ${p.pedido}<br><br>

        üöö ${p.vehiculo}<br>
        üë®‚Äç‚úàÔ∏è ${p.conductor}<br>
        üßæ ${p.liquidador}<br>
        üìû ${p.contacto}

        <ul class="products">
          ${p.productos.map(pr => `<li>${pr}</li>`).join('')}
        </ul>

        <div class="total">Total: S/ ${p.total.toFixed(2)}</div>

        <button class="whatsapp"
          onclick="window.open('https://wa.me/?text=${encodeURIComponent(textoWhatsApp)}','_blank')">
          üì≤ Compartir por WhatsApp
        </button>
      </div>
    `;
  });
}
</script>

</body>
</html>
