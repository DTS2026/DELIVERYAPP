<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hoja de Ruta - Distribucion Grupo DN</title>

<style>
body{
  font-family: 'Segoe UI', sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}

h1{
  text-align:center;
  background: linear-gradient(135deg,#1e3a8a,#2563eb);
  color:white;
  padding:18px;
  border-radius:14px;
  margin-bottom:20px;
  font-weight:600;
  letter-spacing:0.5px;
}

input{
  width:100%;
  padding:12px;
  margin:20px 0;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:16px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}

.resumen-unidades{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
  margin-bottom:25px;
}

.card-unidad{
  background:white;
  padding:16px;
  border-radius:14px;
  box-shadow:0 6px 16px rgba(0,0,0,0.06);
  border-left:6px solid #1e3a8a;
  transition:.2s;
}

.card-unidad:hover{
  transform:translateY(-3px);
}

.card-unidad h3{
  margin:0 0 8px 0;
  color:#1e3a8a;
}

.card{
  background:#fff;
  padding:20px;
  border-radius:16px;
  margin-bottom:20px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
  transition:.2s;
}

.card:hover{
  transform:translateY(-4px);
}

.codigo{
  font-size:14px;
  color:#666;
  margin-bottom:10px;
}

.linea-horizontal{
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  margin-bottom:10px;
}

.info{
  margin-bottom:6px;
}

.btn{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  text-decoration:none;
  display:inline-block;
  margin-right:8px;
  font-size:14px;
  font-weight:500;
}

.btn-detalle{
  background:#1e3a8a;
  color:white;
}

.btn-wsp{
  background:#16a34a;
  color:white;
}

.detalle{
  display:none;
  margin-top:15px;
  border-top:1px solid #eee;
  padding-top:12px;
}

.producto{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}

.desc{ flex:2; }
.cant{ flex:1; text-align:center; }
.monto{ flex:1; text-align:right; }

.totales{
  margin-top:10px;
  border-top:1px solid #ddd;
  padding-top:8px;
}

.subtotal{
  font-weight:bold;
}

.totalgeneral{
  font-weight:bold;
  color:#1e3a8a;
  font-size:16px;
}
</style>
</head>

<body>

<h1>üöö HOJA DE RUTA -DISTRIBUCION GRUPODN</h1>

<div id="resumenUnidades" class="resumen-unidades"></div>

<input type="text" id="buscador" placeholder="Buscar por c√≥digo o nombre de cliente...">

<div id="resultados"></div>

<script>

let pedidos=[];
let debounceTimer=null;

fetch('pedidos.json')
.then(r=>r.json())
.then(data=>{
  pedidos=data;
  generarResumenUnidades();
});

/* NORMALIZADOR */
function normalizarTexto(texto){
  return texto?.toString().toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ")
    .trim();
}

/* MONTO CON ESPACIOS */
function obtenerMonto(obj){
  const key = Object.keys(obj).find(k => k.trim() === "Monto");
  if(!key) return 0;
  const valor=parseFloat(obj[key]);
  return isNaN(valor)?0:valor;
}

/* RESUMEN */
function generarResumenUnidades(){

  const resumen = {};
  const clientesPorUnidad = {};

  pedidos.forEach(p => {

    const unidad = p.unidadNegocio || "Sin Unidad";
    const monto = obtenerMonto(p);

    if(!resumen[unidad]){
      resumen[unidad] = 0;
      clientesPorUnidad[unidad] = new Set();
    }

    resumen[unidad] += monto;
    clientesPorUnidad[unidad].add(p["CODIGO.CLIENTE"]);
  });

  const contenedor = document.getElementById("resumenUnidades");
  contenedor.innerHTML = "";

  Object.keys(resumen).forEach(unidad => {

    contenedor.innerHTML += `
      <div class="card-unidad">
        <h3>üè¢ ${unidad}</h3>
        <div>üë• Clientes: ${clientesPorUnidad[unidad].size}</div>
        <div>üí∞ Total: S/ ${resumen[unidad].toFixed(2)}</div>
      </div>
    `;
  });
}

/* BUSCADOR CORREGIDO */
document.getElementById('buscador').addEventListener('input',()=>{
  clearTimeout(debounceTimer);
  debounceTimer=setTimeout(buscar,250);
});

function buscar(){

  const input = document.getElementById("buscador");
  const resultadosDiv = document.getElementById("resultados");

  const q = normalizarTexto(input.value);
  resultadosDiv.innerHTML='';

  if(q.length<1) return;

  const filtrados=pedidos.filter(p=>{

    const codigo = normalizarTexto(p["CODIGO.CLIENTE"]);
    const nombre = normalizarTexto(p["NOMBRE.CLIENTE"]);

    return codigo?.includes(q) || nombre?.includes(q);
  });

  const agrupados={};

  filtrados.forEach(p=>{
    if(!agrupados[p["CODIGO.CLIENTE"]])
      agrupados[p["CODIGO.CLIENTE"]]=[];
    agrupados[p["CODIGO.CLIENTE"]].push(p);
  });

  Object.values(agrupados).forEach(lista=>renderCliente(lista));
}

/* RENDER */
function renderCliente(lista){

  const p=lista[0];

  const subtotal=lista.reduce((s,x)=> s + obtenerMonto(x),0);
  const igv=subtotal*0.18;
  const totalGeneral=subtotal+igv;

  const div=document.createElement('div');
  div.className='card';

  div.innerHTML=`
    <h3>üè¢ ${p["NOMBRE.CLIENTE"]}</h3>
    <div class="codigo">üÜî C√≥digo Cliente: ${p["CODIGO.CLIENTE"]}</div>

    <div class="linea-horizontal">
      <div>üöõ <strong>Placa:</strong> ${p["VEHICULO"]}</div>
      <div>üë§ <strong>Conductor:</strong> ${p.CONDUCTOR}</div>
    </div>

    <div class="info">üì¶ <strong>Repartidor:</strong> ${p.LIQUIDADOR}</div>
    <div class="info">üìû <strong>Tel√©fonos:</strong> ${p["NROS DE CONTACTO"]}</div>

    <div class="detalle">
      ${lista.map(x=>`
        <div class="producto">
          <div class="desc">${x.Descripcion}</div>
          <div class="cant">${x["Unidades Programadas"]} und</div>
          <div class="monto">S/ ${obtenerMonto(x).toFixed(2)}</div>
        </div>
      `).join('')}

      <div class="totales">
        <div class="subtotal">Subtotal: S/ ${subtotal.toFixed(2)}</div>
        <div>IGV (18%): S/ ${igv.toFixed(2)}</div>
        <div class="totalgeneral">TOTAL GENERAL: S/ ${totalGeneral.toFixed(2)}</div>
      </div>
    </div>
  `;

  document.getElementById("resultados").appendChild(div);
}

</script>

</body>
</html>
