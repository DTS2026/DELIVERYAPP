<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>DISTRIBUCION I HOJA DE RUTA GRUPODN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f4f4f4;
}

header {
  background: #f5b400;
  color: white;
  text-align: center;
  padding: 14px;
  font-weight: bold;
  font-size: 20px;
}

.container {
  padding: 12px;
}

select, input {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  font-size: 16px;
}

.cliente {
  background: white;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 10px;
}

.total {
  font-weight: bold;
  color: #c0392b;
  font-size: 18px;
  margin-top: 6px;
}

.btn {
  background: #2980b9;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 6px;
}

.detalle {
  display: none;
  margin-top: 8px;
  border-top: 1px solid #ddd;
  padding-top: 8px;
}

.producto {
  font-size: 14px;
  margin-bottom: 4px;
}
</style>
</head>

<body>

<header>
DISTRIBUCION I HOJA DE RUTA GRUPODN
</header>

<div class="container">

<select id="unidadSelect">
  <option value="">üìç Unidad de negocio</option>
</select>

<select id="vendedorSelect">
  <option value="">üë§ Vendedor</option>
</select>

<input type="text" id="buscador" placeholder="üîç Buscar por c√≥digo o nombre del cliente">

<div id="resultados"></div>

</div>

<script>
let pedidos = [];
let debounceTimer = null;

fetch('pedidos.json')
.then(r => r.json())
.then(data => {
  pedidos = data;
  cargarUnidades();
});

function cargarUnidades() {
  const unidades = [...new Set(pedidos.map(p => p.unidadNegocio))];
  const sel = document.getElementById('unidadSelect');
  unidades.forEach(u => {
    const o = document.createElement('option');
    o.value = u;
    o.textContent = u;
    sel.appendChild(o);
  });
}

document.getElementById('unidadSelect').addEventListener('change', cargarVendedores);
document.getElementById('vendedorSelect').addEventListener('change', filtrar);
document.getElementById('buscador').addEventListener('input', () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(filtrar, 300);
});

function cargarVendedores() {
  const unidad = unidadSelect.value;
  vendedorSelect.innerHTML = '<option value="">üë§ Vendedor</option>';

  const vendedores = [...new Set(
    pedidos.filter(p => !unidad || p.unidadNegocio === unidad)
           .map(p => p.vendedor)
  )];

  vendedores.forEach(v => {
    const o = document.createElement('option');
    o.value = v;
    o.textContent = v;
    vendedorSelect.appendChild(o);
  });

  resultados.innerHTML = '';
}

function filtrar() {
  const vendedor = vendedorSelect.value;
  const q = buscador.value.toLowerCase();
  resultados.innerHTML = '';

  if (!vendedor) return;

  const filtrados = pedidos.filter(p =>
    p.vendedor === vendedor &&
    (
      p["CODIGO.CLIENTE"].toString().includes(q) ||
      p["NOMBRE.CLIENTE"].toLowerCase().includes(q)
    )
  );

  const agrupados = {};
  filtrados.forEach(p => {
    if (!agrupados[p["CODIGO.CLIENTE"]]) agrupados[p["CODIGO.CLIENTE"]] = [];
    agrupados[p["CODIGO.CLIENTE"]].push(p);
  });

  Object.values(agrupados).forEach(lista => renderCliente(lista));
}

function renderCliente(lista) {
  const p = lista[0];
  const total = lista.reduce((s,x)=>s+x.Monto,0).toFixed(2);

  const div = document.createElement('div');
  div.className = 'cliente';

  div.innerHTML = `
    <strong>${p["NOMBRE.CLIENTE"]}</strong><br>
    C√≥digo: ${p["CODIGO.CLIENTE"]}<br>
    üöö ${p.CONDUCTOR} | üöõ ${p["PLACA.ASIGNADA"]}<br>
    üíº ${p.LIQUIDADOR} | üìû ${p["NROS DE CONTACTO"]}<br>

    <div class="total">TOTAL: S/ ${total}</div>

    <button class="btn" onclick="this.nextElementSibling.style.display =
      this.nextElementSibling.style.display==='block'?'none':'block'">
      Ver detalle
    </button>

    <div class="detalle">
      ${lista.map(x=>`
        <div class="producto">
          ${x.Descripcion} ‚Äî ${x["Unidades Programadas"]} und ‚Äî S/ ${x.Monto}
        </div>`).join('')}
    </div>
  `;

  resultados.appendChild(div);
}
</script>

</body>
</html>
