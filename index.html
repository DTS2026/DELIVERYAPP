<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedidos ‚Äì Ventas</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 10px;
    }

    h1 {
      text-align: center;
      font-size: 20px;
      margin-bottom: 10px;
    }

    input, select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .tabs button {
      flex: 1;
      padding: 10px;
      font-size: 15px;
      border: none;
      border-radius: 6px;
      background: #ddd;
      cursor: pointer;
    }

    .tabs button.active {
      background: #3498db;
      color: #fff;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    ul {
      padding-left: 18px;
      margin-top: 8px;
    }

    li {
      font-size: 14px;
      margin-bottom: 6px;
    }

    .totales {
      margin-top: 8px;
      font-weight: bold;
    }

    .estado-btns {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }

    .estado-btns button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      color: #fff;
    }

    .pendiente { background: #f39c12; }
    .facturado { background: #27ae60; }

    .whatsapp {
      margin-top: 10px;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: #25D366;
      color: white;
      cursor: pointer;
    }
  </style>
</head>

<body>

<h1>üì¶ Pedidos ‚Äì Ventas</h1>

<div class="tabs">
  <button id="btn-buscador" class="active" onclick="mostrarTab('buscador')">üîç Buscador</button>
  <button id="btn-estado" onclick="mostrarTab('estado')">üìä Estado</button>
</div>

<!-- ================= TAB BUSCADOR ================= -->
<div id="tab-buscador">
  <input
    type="text"
    id="buscador"
    placeholder="C√≥digo o nombre del cliente"
    onkeyup="buscarCliente()"
  >
  <div id="resultados"></div>
</div>

<!-- ================= TAB ESTADO ================= -->
<div id="tab-estado" style="display:none;">

  <select id="vendedorFiltro" onchange="listarPorEstado()">
    <option value="">Seleccione Vendedor</option>
  </select>

  <div class="estado-btns">
    <button class="pendiente" onclick="setEstadoListado('PENDIENTE')">Pendiente</button>
    <button class="facturado" onclick="setEstadoListado('FACTURADO')">Facturado</button>
  </div>

  <div id="listaEstado"></div>
</div>

<script>
let pedidos = [];
let estadoListado = 'PENDIENTE';

fetch('pedidos.json')
  .then(res => res.json())
  .then(data => {
    pedidos = data;
    console.log('Pedidos cargados:', pedidos.length);

    // cargar vendedores (tipoCliente)
    const vendedores = [...new Set(data.map(p => p.tipoCliente).filter(v => v))];
    const select = document.getElementById('vendedorFiltro');
    vendedores.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      select.appendChild(opt);
    });
  });

function mostrarTab(tab) {
  document.getElementById('tab-buscador').style.display = 'none';
  document.getElementById('tab-estado').style.display = 'none';
  document.getElementById('btn-buscador').classList.remove('active');
  document.getElementById('btn-estado').classList.remove('active');

  document.getElementById('tab-' + tab).style.display = 'block';
  document.getElementById('btn-' + tab).classList.add('active');
}

/* ================= BUSCADOR ================= */

function buscarCliente() {
  const texto = document.getElementById('buscador').value.trim().toLowerCase();
  const contenedor = document.getElementById('resultados');
  contenedor.innerHTML = '';

  if (texto.length < 2) return;

  const filtrados = pedidos.filter(p =>
    String(p["CODIGO.CLIENTE"]).includes(texto) ||
    p["NOMBRE.CLIENTE"].toLowerCase().includes(texto)
  );

  if (filtrados.length === 0) {
    contenedor.innerHTML = '<p>No se encontraron pedidos</p>';
    return;
  }

  const grupos = {};
  filtrados.forEach(p => {
    if (!grupos[p["CODIGO.CLIENTE"]]) grupos[p["CODIGO.CLIENTE"]] = [];
    grupos[p["CODIGO.CLIENTE"]].push(p);
  });

  Object.values(grupos).forEach(lista => {
    const c = lista[0];
    let totalMonto = 0;
    let totalUni = 0;
    let productos = '';

    lista.forEach(p => {
      totalMonto += Number(p.Monto || 0);
      totalUni += Number(p["Unidades Programadas"] || 0);

      productos += `
        <li>
          ${p.Descripcion}<br>
          <small>${p["Unidades Programadas"]} ${p.unidad}</small>
        </li>
      `;
    });

    contenedor.innerHTML += `
      <div class="card">
        <strong>${c["NOMBRE.CLIENTE"]}</strong><br>
        <small>${c.departamento} - ${c.distrito}</small>

        <ul>${productos}</ul>

        <div class="totales">
          Total Unidades: ${totalUni}<br>
          Total Monto: S/ ${totalMonto.toFixed(2)}
        </div>

        <button class="whatsapp"
          onclick="compartirWhatsApp('${c["NOMBRE.CLIENTE"]}', ${totalMonto})">
          üì≤ Compartir por WhatsApp
        </button>
      </div>
    `;
  });
}

/* ================= ESTADO ================= */

function setEstadoListado(e) {
  estadoListado = e;
  listarPorEstado();
}

function listarPorEstado() {
  const vendedor = document.getElementById('vendedorFiltro').value;
  const cont = document.getElementById('listaEstado');
  cont.innerHTML = '';

  if (!vendedor) return;

  const filtrados = pedidos.filter(p => {
    const pendiente = p.FechaPedido === '‚ö´ Pendiente';
    const cumpleEstado = estadoListado === 'PENDIENTE' ? pendiente : !pendiente;
    return p.tipoCliente === vendedor && cumpleEstado;
  });

  if (filtrados.length === 0) {
    cont.innerHTML = '<p>No hay pedidos</p>';
    return;
  }

  const grupos = {};
  filtrados.forEach(p => {
    if (!grupos[p["CODIGO.CLIENTE"]]) grupos[p["CODIGO.CLIENTE"]] = [];
    grupos[p["CODIGO.CLIENTE"]].push(p);
  });

  Object.values(grupos).forEach(lista => {
    const c = lista[0];
    cont.innerHTML += `
      <div class="card">
        <strong>${c["NOMBRE.CLIENTE"]}</strong><br>
        <small>${c.departamento} - ${c.distrito}</small><br>
        <small>Pedido: ${c["Nro Pedido"] || '-'}</small>
      </div>
    `;
  });
}

function compartirWhatsApp(cliente, total) {
  const msg = `
Cliente: ${cliente}
Total: S/ ${total.toFixed(2)}
  `.trim();

  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
}
</script>

</body>
</html>

